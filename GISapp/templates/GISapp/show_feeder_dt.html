{% extends "GISapp/base.html" %}
{% block style %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
{% endblock %}


{% block content %}
<h2>Select Feeder and DT</h2>
<form method="get" id="feeder-dt-form">
  <label>Feeder:
    <select name="feeder" id="feeder-select" onchange="this.form.submit()">
      <option value="">Select Feeder</option>
      {% for feeder in feeders %}
          <option value="{{ feeder.id }}" {% if feeder.id == selected_feeder %}selected{% endif %}>{{ feeder.name }}</option>
      {% endfor %}
    </select>
  </label>
  {% if dts %}
    <label>DT:
      <select name="dt" id="dt-select">
        <option value="">Select DT</option>
        {% for dt in dts %}
            <option value="{{ dt.id }}" {% if dt.id == selected_dt %}selected{% endif %}>
              {{ dt.name }} ({{ dt.capacity }} kVA)
            </option>
        {% endfor %}
      </select>
    </label>
    <button type="submit" name="show" value="1">Show</button>
  {% endif %}
</form>

{% if results %}
  <hr>
  <h3>Records:</h3>
  <ul>
    {% for r in results %}
      <li>Start: [{{ r.start_point_lat }}, {{ r.start_point_lng }}]
          End: [{{ r.end_point_lat }}, {{ r.end_point_lng }}]
      </li>
    {% endfor %}
  </ul>
  <div id="map" style="height:400px;width:100%;"></div>
<script>
function initMap() {
    var map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: { lat: {{ results.0.start_point_lat }}, lng: {{ results.0.start_point_lng }} }
    });

    const directionsService = new google.maps.DirectionsService();

    {% for r in results %}
        var start = { lat: {{ r.start_point_lat }}, lng: {{ r.start_point_lng }} };
        var end = { lat: {{ r.end_point_lat }}, lng: {{ r.end_point_lng }} };

        // Add start and end markers
        new google.maps.Marker({
            position: start,
            map: map,
            title: "Start"
        });
        new google.maps.Marker({
            position: end,
            map: map,
            title: "End"
        });

        // Draw route along roads (each with its own DirectionsRenderer)
        directionsService.route(
            {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING
            },
            (result, status) => {
                if (status === "OK" && result) {
                    // Unique renderer for each route
                    let renderer = new google.maps.DirectionsRenderer({
                        map: map,
                        suppressMarkers: true // We already added markers
                    });
                    renderer.setDirections(result);
                } else {
                    console.error("Directions request failed: " + status);
                }
            }
        );
    {% endfor %}
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFOhU2DZeJCo0MEk8J7iKwpKQRdc6CpmU&callback=initMap" async></script>

{% endif %}
{% endblock %}
